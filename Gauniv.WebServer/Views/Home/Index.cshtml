@model List<Gauniv.WebServer.Data.Game>
@{
    ViewData["Title"] = "Boutique de Jeux";
}

<div class="container">
    <div class="text-center mb-4">
        <h1 class="display-4">🎮 Boutique de Jeux Gauniv</h1>
        <p class="lead">Découvrez notre collection de jeux</p>
    </div>

    <!-- Filtres -->
    <div class="filter-section">
        <form method="get" asp-action="Index">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">🔍 Rechercher</label>
                    <input type="text" class="form-control" name="search" value="@ViewBag.Search" placeholder="Nom ou description...">
                </div>
                <div class="col-md-2">
                    <label class="form-label">📁 Catégorie</label>
                    <select class="form-select" name="categoryId">
                        <option value="">Toutes</option>
                        @foreach (var category in (List<Gauniv.WebServer.Data.Category>)ViewBag.Categories)
                        {
                            <option value="@category.Id" selected="@(ViewBag.CategoryId == category.Id)">@category.Name</option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">💰 Prix Min</label>
                    <input type="number" class="form-control" name="minPrice" value="@ViewBag.MinPrice" placeholder="0" step="0.01">
                </div>
                <div class="col-md-2">
                    <label class="form-label">💰 Prix Max</label>
                    <input type="number" class="form-control" name="maxPrice" value="@ViewBag.MaxPrice" placeholder="999" step="0.01">
                </div>
                @if (User.Identity?.IsAuthenticated == true)
                {
                    <div class="col-md-2">
                        <label class="form-label">📦 Possession</label>
                        <select class="form-select" name="owned">
                            <option value="">Tous</option>
                            <option value="true" selected="@(ViewBag.Owned == true)">Possédés</option>
                            <option value="false" selected="@(ViewBag.Owned == false)">Non possédés</option>
                        </select>
                    </div>
                }
                <div class="col-md-1 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">Filtrer</button>
                </div>
            </div>
        </form>
    </div>

    <!-- Liste des jeux -->
    @if (Model.Any())
    {
        <div class="row">
            @foreach (var game in Model)
            {
                <div class="col-md-4 mb-4">
                    <div class="card game-card">
                        <div class="game-card-header">
                            @game.Name
                        </div>
                        <div class="game-card-body">
                            <div class="game-description">
                                @(game.Description.Length > 100 ? game.Description.Substring(0, 100) + "..." : game.Description)
                            </div>
                            <div class="my-3">
                                @foreach (var gc in game.GameCategories)
                                {
                                    <span class="category-badge">@gc.Category.Name</span>
                                }
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="game-price">@game.Price.ToString("C")</div>
                                <div>
                                    <span class="text-muted small">📦 @(game.Payload.Length / 1024) KB</span>
                                </div>
                            </div>
                            <div class="mt-3">
                                @if (User.Identity?.IsAuthenticated == true)
                                {
                                    var isOwned = ((HashSet<int>)ViewBag.OwnedGameIds).Contains(game.Id);
                                    if (isOwned)
                                    {
                                        <div class="alert alert-success mb-2 py-2">
                                            ✅ <strong>Possédé</strong>
                                        </div>
                                        <a asp-action="MyGames" class="btn btn-outline-primary w-100">
                                            📚 Voir dans ma bibliothèque
                                        </a>
                                    }
                                    else
                                    {
                                        <button class="btn btn-success w-100" onclick="purchaseGame(@game.Id, '@game.Name')">
                                            💳 Acheter
                                        </button>
                                    }
                                }
                                else
                                {
                                    <a asp-area="Identity" asp-page="/Account/Login" class="btn btn-primary w-100">
                                        🔐 Connexion requise
                                    </a>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="alert alert-info text-center">
            <h4>😕 Aucun jeu trouvé</h4>
            <p>Essayez de modifier vos filtres de recherche.</p>
        </div>
    }
</div>

@section Scripts {
    <script>
        async function purchaseGame(gameId, gameName) {
            const result = await Swal.fire({
                title: 'Confirmer l\'achat',
                text: `Voulez-vous vraiment acheter "${gameName}" ?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#198754',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '💳 Acheter',
                cancelButtonText: 'Annuler'
            });

            if (!result.isConfirmed) return;

            try {
                const response = await fetch(`/api/1.0.0/games/PurchaseGame?id=${gameId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                const data = await response.json();

                if (response.ok) {
                    await Swal.fire({
                        title: 'Succès !',
                        text: data.message,
                        icon: 'success',
                        confirmButtonColor: '#198754'
                    });
                    location.reload();
                } else {
                    Swal.fire({
                        title: 'Erreur',
                        text: data.message || 'Erreur lors de l\'achat',
                        icon: 'error',
                        confirmButtonColor: '#dc3545'
                    });
                }
            } catch (error) {
                Swal.fire({
                    title: 'Erreur',
                    text: 'Erreur de connexion au serveur',
                    icon: 'error',
                    confirmButtonColor: '#dc3545'
                });
                console.error(error);
            }
        }
    </script>
}