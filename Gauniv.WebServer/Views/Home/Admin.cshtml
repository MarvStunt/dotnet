@model List<Gauniv.WebServer.Data.Game>
@{
    ViewData["Title"] = "Administration";
    var categories = (List<Gauniv.WebServer.Data.Category>)ViewBag.Categories;
    var stats = (dynamic)ViewBag.Stats ?? new { TotalRevenue = 0m, TotalGames = 0, TotalUsers = 0, ActiveUsers = 0 };
}

@functions {
    public string EscapeJsString(string input)
    {
        if (string.IsNullOrEmpty(input)) return "";
        return System.Web.HttpUtility.JavaScriptStringEncode(input);
    }
}

<div class="admin-wrapper">
    <!-- Sidebar Navigation -->
    <aside class="admin-sidebar">
        <div class="sidebar-header">
            <h3>Admin Panel</h3>
            <p>Manage your game store</p>
        </div>
        <ul class="admin-sidebar-menu">
            <li><a href="#dashboard" class="active"><i class="icon">üìä</i> Dashboard</a></li>
            <li><a href="#games"><i class="icon">üéÆ</i> Games</a></li>
            <li><a href="#categories"><i class="icon">üìÅ</i> Categories</a></li>
            <li><a href="#users"><i class="icon">üë•</i> Users</a></li>
            <li><a href="/"><i class="icon">üè†</i> Back to Store</a></li>
        </ul>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
        <!-- Header -->
        <div class="admin-header" id="dashboard">
            <h1>Dashboard</h1>
            <p>Overview of your game store performance</p>
        </div>

        <!-- Statistics Cards -->
        <div class="dashboard-stats">
            <div class="stat-card-modern">
                <div class="stat-card-modern-header">
                    <div>
                        <p class="stat-card-modern-title">Total Revenue</p>
                        <div class="stat-card-modern-value" id="totalRevenueValue">$0</div>
                    </div>
                    <div class="stat-card-modern-icon">üí∞</div>
                </div>
            </div>

            <div class="stat-card-modern">
                <div class="stat-card-modern-header">
                    <div>
                        <p class="stat-card-modern-title">Total Games</p>
                        <div class="stat-card-modern-value" id="totalGamesValue">@stats.TotalGames</div>
                        <p class="stat-card-modern-change">Games in catalog</p>
                    </div>
                    <div class="stat-card-modern-icon">üéÆ</div>
                </div>
            </div>

            <div class="stat-card-modern">
                <div class="stat-card-modern-header">
                    <div>
                        <p class="stat-card-modern-title">Total Users</p>
                        <div class="stat-card-modern-value" id="totalUsersValue">@stats.TotalUsers</div>
                        <p class="stat-card-modern-change" id="usersChange">+8.2% from last month</p>
                    </div>
                    <div class="stat-card-modern-icon">üë•</div>
                </div>
            </div>

            <div class="stat-card-modern">
                <div class="stat-card-modern-header">
                    <div>
                        <p class="stat-card-modern-title">Active Users</p>
                        <div class="stat-card-modern-value" id="activeUsersValue">@stats.ActiveUsers</div>
                        <p class="stat-card-modern-change">Last 30 days</p>
                    </div>
                    <div class="stat-card-modern-icon">üìà</div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px; margin-bottom: 30px;">
            <!-- Revenue by Month Chart -->
            <div class="dashboard-section">
                <div class="dashboard-section-header">
                    <div>
                        <h2 class="dashboard-section-title">Revenue by Month</h2>
                        <p class="dashboard-section-subtitle">Monthly revenue over the last 6 months</p>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>

            <!-- Top Selling Games Chart -->
            <div class="dashboard-section">
                <div class="dashboard-section-header">
                    <div>
                        <h2 class="dashboard-section-title">Top Selling Games</h2>
                        <p class="dashboard-section-subtitle">Best performers by sales volume</p>
                    </div>
                </div>
                <div style="padding: 20px 0;" id="topSellingGamesContainer">
                    <p style="text-align: center; color: #a0aec0; padding: 20px;">Loading...</p>
                </div>
            </div>
        </div>
        <div class="dashboard-section" id="games">
            <div class="dashboard-section-header">
                <div>
                    <h2 class="dashboard-section-title">üéÆ Gestion des Jeux</h2>
                    <p class="dashboard-section-subtitle">Best performers by sales volume</p>
                </div>
                <button class="btn btn-admin-primary" data-bs-toggle="modal" data-bs-target="#addGameModal">
                    ‚ûï Add Game
                </button>
            </div>

            <div class="table-responsive">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Price</th>
                            <th>Size</th>
                            <th>Categories</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="gamesTableBody">
                        @if (Model?.Count > 0)
                        {
                            @foreach (var game in Model.Take(10))
                            {
                                <tr>
                                    <td>@game.Id</td>
                                    <td>@game.Name</td>
                                    <td>@game.Price.ToString("C")</td>
                                    <td>@(game.Payload.Length / 1024) KB</td>
                                    <td>
                                        @foreach (var gc in game.GameCategories)
                                        {
                                            <span class="category-badge">@gc.Category.Name</span>
                                        }
                                    </td>
                                    <td>
                                        <button class="btn btn-admin-primary" style="font-size: 0.85rem; padding: 6px 12px; margin-right: 5px;" onclick="openEditGameModal(@game.Id, '@EscapeJsString(game.Name)', '@EscapeJsString(game.Description)', @game.Price, '@string.Join(",", game.GameCategories.Select(gc => gc.CategoryId))')">
                                            ‚úèÔ∏è Edit
                                        </button>
                                        <button class="btn btn-admin-danger" onclick="deleteGame(@game.Id, '@EscapeJsString(game.Name)')">
                                            üóëÔ∏è Delete
                                        </button>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 40px; color: #a0aec0;">
                                    No games found. Create your first game!
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination for Games -->
            @if (Model?.Count > 10)
            {
                <nav aria-label="Games pagination" style="margin-top: 20px;">
                    <ul class="pagination justify-content-center" id="gamesPagination" style="gap: 8px;">
                        <li class="page-item" id="prevPageBtn">
                            <a class="page-link" href="#" onclick="previousGamePage(event)" style="background: #667eea; color: white; border: none; padding: 8px 12px; border-radius: 6px;">‚Üê Previous</a>
                        </li>
                        <li class="page-item" id="pageInfo" style="display: flex; align-items: center; padding: 0 10px; color: #cbd5e0;">
                            Page <span id="currentGamePage" style="font-weight: bold; margin: 0 5px;">1</span> of <span id="totalGamePages" style="font-weight: bold; margin-left: 5px;">@Math.Ceiling((double)Model.Count / 10)</span>
                        </li>
                        <li class="page-item" id="nextPageBtn">
                            <a class="page-link" href="#" onclick="nextGamePage(event)" style="background: #667eea; color: white; border: none; padding: 8px 12px; border-radius: 6px;">Next ‚Üí</a>
                        </li>
                    </ul>
                </nav>

                <script>
                    let gamesData = [
                        @foreach (var game in Model)
                        {
                            var categoryIds = string.Join(",", game.GameCategories.Select(gc => gc.CategoryId));
                            var categoryNames = string.Join("|", game.GameCategories.Select(gc => gc.Category.Name));
                            <text>
                            {
                                id: @game.Id,
                                name: '@EscapeJsString(game.Name)',
                                description: '@EscapeJsString(game.Description)',
                                price: @game.Price.ToString(System.Globalization.CultureInfo.InvariantCulture),
                                payloadSize: @(game.Payload.Length / 1024),
                                categoryIds: '@categoryIds',
                                categoryNames: '@categoryNames'
                            },
                            </text>
                        }
                    ];

                    // Remove trailing comma
                    if (gamesData.length > 0 && gamesData[gamesData.length - 1] === ',') {
                        gamesData.pop();
                    }

                    let currentGamePage = 1;
                    const gamesPerPage = 10;

                    function renderGamesPage(pageNum) {
                        const start = (pageNum - 1) * gamesPerPage;
                        const end = start + gamesPerPage;
                        const paginatedGames = gamesData.slice(start, end);
                        
                        let html = '';
                        if (paginatedGames.length === 0) {
                            html = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #a0aec0;">No games found.</td></tr>';
                        } else {
                            paginatedGames.forEach(game => {
                                const categoriesHtml = game.categoryNames
                                    .split('|')
                                    .filter(c => c)
                                    .map(c => `<span class="category-badge">${c}</span>`)
                                    .join('');
                                
                                html += `<tr>
                                    <td>${game.id}</td>
                                    <td>${game.name}</td>
                                    <td>$${game.price.toFixed(2)}</td>
                                    <td>${game.payloadSize} KB</td>
                                    <td>${categoriesHtml}</td>
                                    <td>
                                        <button class="btn btn-admin-primary" style="font-size: 0.85rem; padding: 6px 12px; margin-right: 5px;" onclick="openEditGameModal(${game.id}, '${game.name}', '${game.description}', ${game.price}, '${game.categoryIds}')">
                                            ‚úèÔ∏è Edit
                                        </button>
                                        <button class="btn btn-admin-danger" onclick="deleteGame(${game.id}, '${game.name}')">
                                            üóëÔ∏è Delete
                                        </button>
                                    </td>
                                </tr>`;
                            });
                        }
                        
                        document.getElementById('gamesTableBody').innerHTML = html;
                        updateGamesPaginationButtons(pageNum);
                    }

                    function updateGamesPaginationButtons(pageNum) {
                        const totalPages = Math.ceil(gamesData.length / gamesPerPage);
                        document.getElementById('currentGamePage').textContent = pageNum;
                        document.getElementById('totalGamePages').textContent = totalPages;
                        document.getElementById('prevPageBtn').style.opacity = pageNum === 1 ? '0.5' : '1';
                        document.getElementById('prevPageBtn').style.pointerEvents = pageNum === 1 ? 'none' : 'auto';
                        document.getElementById('nextPageBtn').style.opacity = pageNum === totalPages ? '0.5' : '1';
                        document.getElementById('nextPageBtn').style.pointerEvents = pageNum === totalPages ? 'none' : 'auto';
                    }

                    function nextGamePage(e) {
                        e.preventDefault();
                        const totalPages = Math.ceil(gamesData.length / gamesPerPage);
                        if (currentGamePage < totalPages) {
                            currentGamePage++;
                            renderGamesPage(currentGamePage);
                        }
                    }

                    function previousGamePage(e) {
                        e.preventDefault();
                        if (currentGamePage > 1) {
                            currentGamePage--;
                            renderGamesPage(currentGamePage);
                        }
                    }

                    // Initialize pagination on load
                    document.addEventListener('DOMContentLoaded', function() {
                        renderGamesPage(1);
                    });
                </script>
            }
            else if (Model?.Count > 0)
            {
                <div style="text-align: center; margin-top: 20px; color: #cbd5e0;">
                    <small>Showing @Model.Count game(s)</small>
                </div>
            }
        </div>

        <!-- Categories Section -->
        <div class="dashboard-section" id="categories">
            <div class="dashboard-section-header">
                <div>
                    <h2 class="dashboard-section-title">üìÅ Gestion des Cat√©gories</h2>
                    <p class="dashboard-section-subtitle">Manage game categories</p>
                </div>
            </div>

            <!-- Add Category Form -->
            <div style="background: rgba(45, 55, 72, 0.5); padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                <h4 style="color: white; margin-top: 0;">Add a New Category</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; align-items: end;">
                    <div class="admin-form-group" style="margin-bottom: 0;">
                        <label for="categoryName">Category Name</label>
                        <input type="text" class="form-control" id="categoryName" >
                    </div>
                    <div class="admin-form-group" style="margin-bottom: 0;">
                        <label for="categoryDescription">Description</label>
                        <input type="text" class="form-control" id="categoryDescription" >
                    </div>
                    <button class="btn btn-admin-success" onclick="addCategory()">
                        ‚ûï Add Category
                    </button>
                </div>
            </div>

            <!-- Categories Grid -->
            <div class="category-grid">
                @foreach (var category in categories)
                {
                    <div class="category-card">
                        <h6>@category.Name</h6>
                        <p>@category.Description</p>
                        <button class="btn btn-admin-primary w-100" style="margin-bottom: 8px;" onclick="openEditCategoryModal(@category.Id, '@EscapeJsString(category.Name)', '@EscapeJsString(category.Description)')">
                            ‚úèÔ∏è Edit
                        </button>
                        <button class="btn btn-admin-danger w-100" onclick="deleteCategory(@category.Id, '@EscapeJsString(category.Name)')">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                }
            </div>
        </div>

        <!-- Users Section -->
        <div class="dashboard-section" id="users">
            <div class="dashboard-section-header">
                <div>
                    <h2 class="dashboard-section-title">üë• User Management</h2>
                    <p class="dashboard-section-subtitle">Manage registered users</p>
                </div>
            </div>

            <div class="table-responsive">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Games Owned</th>
                            <th>Registration Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: #a0aec0;">
                                Loading users...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>
</div>

<!-- Modal Ajouter un Jeu -->
<div class="modal fade" id="addGameModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajouter un Nouveau Jeu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addGameForm">
                    <div class="mb-3">
                        <label class="custom-form-label">Nom du Jeu</label>
                        <input type="text" class="form-control" id="gameName" required>
                    </div>
                    <div class="mb-3">
                        <label class="custom-form-label">Description</label>
                        <textarea class="form-control" id="gameDescription" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="custom-form-label">Prix (‚Ç¨)</label>
                        <input type="number" class="form-control" id="gamePrice" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label class="custom-form-label">Fichier du Jeu</label>
                        <input type="file" class="form-control" id="gamePayload" required>
                    </div>
                    <div class="mb-3">
                        <label class="custom-form-label">Cat√©gories</label>
                        <select class="form-select" id="gameCategories" multiple>
                            @foreach (var category in categories)
                            {
                                <option value="@category.Id">@category.Name</option>
                            }
                        </select>
                        <small class="text-muted">Maintenez Ctrl pour s√©lectionner plusieurs cat√©gories</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="submitGame()">Cr√©er le Jeu</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Edit Game -->
<div class="modal fade" id="editGameModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Game</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editGameForm">
                    <input type="hidden" id="editGameId">
                    <div class="mb-3">
                        <label class="custom-form-label">Game Name</label>
                        <input type="text" class="form-control" id="editGameName" required>
                    </div>
                    <div class="mb-3">
                        <label class="custom-form-label">Description</label>
                        <textarea class="form-control" id="editGameDescription" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="custom-form-label">Price (‚Ç¨)</label>
                        <input type="number" class="form-control" id="editGamePrice" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label class="custom-form-label">Game File (Optional - leave empty to keep current)</label>
                        <input type="file" class="form-control" id="editGamePayload">
                    </div>
                    <div class="mb-3">
                        <label class="custom-form-label">Categories</label>
                        <select class="form-select" id="editGameCategories" multiple>
                            @foreach (var category in categories)
                            {
                                <option value="@category.Id">@category.Name</option>
                            }
                        </select>
                        <small class="text-muted">Hold Ctrl to select multiple categories</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitEditGame()">Update Game</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Edit Category -->
<div class="modal fade" id="editCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editCategoryForm">
                    <input type="hidden" id="editCategoryId">
                    <div class="mb-3">
                        <label class="custom-form-label">Category Name</label>
                        <input type="text" class="form-control" id="editCategoryName" required>
                    </div>
                    <div class="mb-3">
                        <label class="custom-form-label">Description</label>
                        <input type="text" class="form-control" id="editCategoryDescription" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitEditCategory()">Update Category</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script>
        async function addCategory() {
            const name = document.getElementById('categoryName').value;
            const description = document.getElementById('categoryDescription').value;

            if (!name) {
                alert('Le nom est requis');
                return;
            }

            try {
                const response = await fetch('/api/1.0.0/categories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description }),
                    credentials: 'include'
                });

                const data = await response.json();
                if (response.ok) {
                    await Swal.fire({
                        title: 'Succ√®s !',
                        text: data.message,
                        icon: 'success',
                        confirmButtonColor: '#198754'
                    });
                    location.reload();
                } else {
                    Swal.fire({
                        title: 'Erreur',
                        text: data.message,
                        icon: 'error',
                        confirmButtonColor: '#dc3545'
                    });
                }
            } catch (error) {
                Swal.fire({
                    title: 'Erreur',
                    text: 'Erreur de connexion',
                    icon: 'error',
                    confirmButtonColor: '#dc3545'
                });
            }
        }

        async function deleteCategory(id, name) {
            const result = await Swal.fire({
                title: '√ätes-vous s√ªr ?',
                text: `Supprimer la cat√©gorie "${name}" ?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Oui, supprimer',
                cancelButtonText: 'Annuler'
            });

            if (!result.isConfirmed) return;

            try {
                const response = await fetch(`/api/1.0.0/categories/${id}`, { 
                    method: 'DELETE',
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (response.ok) {
                    await Swal.fire({
                        title: 'Supprim√© !',
                        text: data.message,
                        icon: 'success',
                        confirmButtonColor: '#198754'
                    });
                    location.reload();
                } else {
                    Swal.fire({
                        title: 'Erreur',
                        text: data.message,
                        icon: 'error',
                        confirmButtonColor: '#dc3545'
                    });
                }
            } catch (error) {
                Swal.fire({
                    title: 'Erreur',
                    text: 'Erreur de connexion',
                    icon: 'error',
                    confirmButtonColor: '#dc3545'
                });
            }
        }

        async function submitGame() {
            const nameInput = document.getElementById('gameName').value;
            const descriptionInput = document.getElementById('gameDescription').value;
            const priceInput = document.getElementById('gamePrice').value;
            const payloadFile = document.getElementById('gamePayload').files[0];

            // Validation
            if (!nameInput || !descriptionInput || !priceInput || !payloadFile) {
                Swal.fire({
                    title: 'Champs manquants',
                    text: 'Veuillez remplir tous les champs et s√©lectionner un fichier',
                    icon: 'warning',
                    confirmButtonColor: '#ffc107'
                });
                return;
            }

            const formData = new FormData();
            formData.append('name', nameInput);
            formData.append('description', descriptionInput);
            formData.append('price', priceInput);
            formData.append('payload', payloadFile);

            const categories = Array.from(document.getElementById('gameCategories').selectedOptions)
                .map(opt => opt.value)
                .join(',');
            formData.append('categoryIds', categories);

            try {
                const response = await fetch('/api/1.0.0/games/CreateGame', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });

                const data = await response.json();
                if (response.ok) {
                    await Swal.fire({
                        title: 'Succ√®s !',
                        text: 'Jeu cr√©√© avec succ√®s !',
                        icon: 'success',
                        confirmButtonColor: '#198754'
                    });
                    location.reload();
                } else {
                    Swal.fire({
                        title: 'Erreur',
                        text: data.message || 'Erreur',
                        icon: 'error',
                        confirmButtonColor: '#dc3545'
                    });
                }
            } catch (error) {
                Swal.fire({
                    title: 'Erreur',
                    text: 'Erreur de connexion',
                    icon: 'error',
                    confirmButtonColor: '#dc3545'
                });
            }
        }

        async function deleteGame(id, name) {
            const result = await Swal.fire({
                title: '√ätes-vous s√ªr ?',
                text: `Supprimer le jeu "${name}" ?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Oui, supprimer',
                cancelButtonText: 'Annuler'
            });

            if (!result.isConfirmed) return;

            try {
                const response = await fetch(`/api/1.0.0/games/DeleteGame/${id}`, { 
                    method: 'DELETE',
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (response.ok) {
                    await Swal.fire({
                        title: 'Supprim√© !',
                        text: data.message,
                        icon: 'success',
                        confirmButtonColor: '#198754'
                    });
                    location.reload();
                } else {
                    Swal.fire({
                        title: 'Erreur',
                        text: data.message,
                        icon: 'error',
                        confirmButtonColor: '#dc3545'
                    });
                }
            } catch (error) {
                Swal.fire({
                    title: 'Erreur',
                    text: 'Erreur de connexion',
                    icon: 'error',
                    confirmButtonColor: '#dc3545'
                });
            }
        }

        // Edit Game Functions
        function openEditGameModal(id, name, description, price, categoryIds) {
            document.getElementById('editGameId').value = id;
            document.getElementById('editGameName').value = name;
            document.getElementById('editGameDescription').value = description;
            document.getElementById('editGamePrice').value = price;

            // Set selected categories
            const categorySelect = document.getElementById('editGameCategories');
            const selectedIds = categoryIds ? categoryIds.split(',') : [];
            Array.from(categorySelect.options).forEach(option => {
                option.selected = selectedIds.includes(option.value);
            });

            const modal = new bootstrap.Modal(document.getElementById('editGameModal'));
            modal.show();
        }

        async function submitEditGame() {
            const gameId = document.getElementById('editGameId').value;
            const name = document.getElementById('editGameName').value;
            const description = document.getElementById('editGameDescription').value;
            const price = document.getElementById('editGamePrice').value;
            const payloadFile = document.getElementById('editGamePayload').files[0];

            if (!name || !description || !price) {
                Swal.fire({
                    title: 'Missing Fields',
                    text: 'Please fill in all required fields',
                    icon: 'warning',
                    confirmButtonColor: '#ffc107'
                });
                return;
            }

            const formData = new FormData();
            formData.append('name', name);
            formData.append('description', description);
            formData.append('price', price);
            
            if (payloadFile) {
                formData.append('payload', payloadFile);
            }

            const categoryIds = Array.from(document.getElementById('editGameCategories').selectedOptions)
                .map(opt => opt.value)
                .join(',');
            formData.append('categoryIds', categoryIds);

            try {
                const response = await fetch(`/api/1.0.0/games/UpdateGame/${gameId}`, {
                    method: 'PUT',
                    body: formData,
                    credentials: 'include'
                });

                const data = await response.json();
                if (response.ok) {
                    await Swal.fire({
                        title: 'Success!',
                        text: 'Game updated successfully!',
                        icon: 'success',
                        confirmButtonColor: '#198754'
                    });
                    location.reload();
                } else {
                    Swal.fire({
                        title: 'Error',
                        text: data.message || 'Error',
                        icon: 'error',
                        confirmButtonColor: '#dc3545'
                    });
                }
            } catch (error) {
                Swal.fire({
                    title: 'Error',
                    text: 'Connection error',
                    icon: 'error',
                    confirmButtonColor: '#dc3545'
                });
            }
        }

        // Edit Category Functions
        function openEditCategoryModal(id, name, description) {
            document.getElementById('editCategoryId').value = id;
            document.getElementById('editCategoryName').value = name;
            document.getElementById('editCategoryDescription').value = description;

            const modal = new bootstrap.Modal(document.getElementById('editCategoryModal'));
            modal.show();
        }

        async function submitEditCategory() {
            const categoryId = document.getElementById('editCategoryId').value;
            const name = document.getElementById('editCategoryName').value;
            const description = document.getElementById('editCategoryDescription').value;

            if (!name || !description) {
                Swal.fire({
                    title: 'Missing Fields',
                    text: 'Please fill in all required fields',
                    icon: 'warning',
                    confirmButtonColor: '#ffc107'
                });
                return;
            }

            try {
                const response = await fetch(`/api/1.0.0/categories/${categoryId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description }),
                    credentials: 'include'
                });

                const data = await response.json();
                if (response.ok) {
                    await Swal.fire({
                        title: 'Success!',
                        text: 'Category updated successfully!',
                        icon: 'success',
                        confirmButtonColor: '#198754'
                    });
                    location.reload();
                } else {
                    Swal.fire({
                        title: 'Error',
                        text: data.message || 'Error',
                        icon: 'error',
                        confirmButtonColor: '#dc3545'
                    });
                }
            } catch (error) {
                Swal.fire({
                    title: 'Error',
                    text: 'Connection error',
                    icon: 'error',
                    confirmButtonColor: '#dc3545'
                });
            }
        }

        // Chart.js Initialization
        document.addEventListener('DOMContentLoaded', function() {
            initRevenueChart();
            initSidebarLinks();
            loadUsers();
            loadDashboardStats();
            loadTopSellingGames();
        });

        async function loadDashboardStats() {
            try {
                const response = await fetch('/api/1.0.0/stats/dashboard-stats', {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch dashboard stats');
                }

                const stats = await response.json();

                // Update the stat cards
                document.getElementById('totalRevenueValue').textContent = '$' + Math.floor(stats.totalRevenue);
                document.getElementById('totalGamesValue').textContent = stats.totalGames;
                document.getElementById('totalUsersValue').textContent = stats.totalUsers;
                document.getElementById('activeUsersValue').textContent = stats.activeUsers;

            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }

        async function loadTopSellingGames() {
            try {
                const response = await fetch('/api/1.0.0/stats/top-selling-games', {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch top selling games');
                }

                const games = await response.json();
                const container = document.getElementById('topSellingGamesContainer');

                if (!container) return;

                if (games.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #a0aec0; padding: 20px;">No sales data available</p>';
                    return;
                }

                container.innerHTML = games.map(game => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #4a5568;">
                        <div>
                            <p style="margin: 0; color: white; font-weight: 500;">${game.gameName}</p>
                            <p style="margin: 5px 0 0 0; font-size: 0.9rem; color: #a0aec0;">${game.sales} sales</p>
                        </div>
                        <p style="margin: 0; color: #667eea; font-weight: 700; font-size: 1.1rem;">$${game.price.toFixed(2)}</p>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading top selling games:', error);
                const container = document.getElementById('topSellingGamesContainer');
                if (container) {
                    container.innerHTML = '<p style="text-align: center; color: #f56565; padding: 20px;">Error loading games</p>';
                }
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch('/api/1.0.0/users', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch users');
                }

                const users = await response.json();
                const usersTableBody = document.getElementById('usersTableBody');
                
                if (!usersTableBody) return;

                if (users.length === 0) {
                    usersTableBody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: #a0aec0;">
                                No users found
                            </td>
                        </tr>
                    `;
                    return;
                }

                usersTableBody.innerHTML = users.map(user => `
                    <tr>
                        <td>${user.id.substring(0, 8)}...</td>
                        <td>${user.userName || 'N/A'}</td>
                        <td>${user.email || 'N/A'}</td>
                        <td><span class="category-badge">${user.roles ? user.roles.join(', ') : 'User'}</span></td>
                        <td>${new Date(user.createdAt || Date.now()).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-admin-danger" onclick="deleteUser('${user.id}', '${user.userName}')">
                                üóëÔ∏è Delete
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading users:', error);
                const usersTableBody = document.getElementById('usersTableBody');
                if (usersTableBody) {
                    usersTableBody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: #f56565;">
                                Error loading users: ${error.message}
                            </td>
                        </tr>
                    `;
                }
            }
        }

        async function deleteUser(userId, username) {
            const result = await Swal.fire({
                title: 'Are you sure?',
                text: `Delete user "${username}"?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, delete',
                cancelButtonText: 'Cancel'
            });

            if (!result.isConfirmed) return;

            try {
                const response = await fetch(`/api/1.0.0/users/${userId}`, { 
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    await Swal.fire({
                        title: 'Deleted!',
                        text: 'User deleted successfully',
                        icon: 'success',
                        confirmButtonColor: '#198754'
                    });
                    loadUsers(); // Reload the users list
                } else {
                    const data = await response.json();
                    Swal.fire({
                        title: 'Error',
                        text: data.message || 'Failed to delete user',
                        icon: 'error',
                        confirmButtonColor: '#dc3545'
                    });
                }
            } catch (error) {
                Swal.fire({
                    title: 'Error',
                    text: 'Connection error',
                    icon: 'error',
                    confirmButtonColor: '#dc3545'
                });
            }
        }

        async function initRevenueChart() {
            const ctx = document.getElementById('revenueChart');
            if (!ctx) return;

            try {
                const response = await fetch('/api/1.0.0/stats/revenue-by-month', {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch revenue data');
                }

                const data = await response.json();
                const months = data.map(d => d.month);
                const revenues = data.map(d => d.revenue);

                // Generate colors array
                const colors = revenues.map((_, i) => i === revenues.length - 1 
                    ? 'rgba(102, 126, 234, 0.95)' 
                    : 'rgba(102, 126, 234, 0.8)');
                const borderColors = revenues.map(() => 'rgba(102, 126, 234, 1)');

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Revenue ($)',
                            data: revenues,
                            backgroundColor: colors,
                            borderColor: borderColors,
                            borderWidth: 0,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(74, 85, 104, 0.3)',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#a0aec0'
                                }
                            },
                            x: {
                                grid: {
                                    display: false,
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#a0aec0'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error initializing revenue chart:', error);
            }
        }

        function initSidebarLinks() {
            const sidebarLinks = document.querySelectorAll('.admin-sidebar-menu a');
            const adminMain = document.querySelector('.admin-main');
            
            sidebarLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    if (this.getAttribute('href').startsWith('#')) {
                        e.preventDefault();
                        sidebarLinks.forEach(l => l.classList.remove('active'));
                        this.classList.add('active');
                        
                        const targetId = this.getAttribute('href').substring(1);
                        const targetSection = document.getElementById(targetId);
                        if (targetSection && adminMain) {
                            // Scroll to top first
                            adminMain.scrollTop = 0;
                            
                            // Then scroll to the target section
                            setTimeout(() => {
                                const elementPosition = targetSection.offsetTop;
                                adminMain.scrollTo({
                                    top: elementPosition,
                                    behavior: 'smooth'
                                });
                            }, 100);
                        }
                    }
                });
            });
        }
    </script>
}
